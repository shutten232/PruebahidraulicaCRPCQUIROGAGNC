<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Simulador PH – ENARGAS/ISO (Orden operativo)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --panel:rgba(15,23,42,0.96);
      --card:#020617;
      --border:#273244;
      --text:#f3f4f6;
      --muted:#cbd5e1;
      --accent:#f97316;
      --accent2:#dc2626;
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif}
    body{
      min-height:100vh;
      background:radial-gradient(circle at top,#111827 0,#020617 55%,#000 100%);
      color:var(--text);
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:12px;
    }
    .app{
      width:100%;
      max-width:980px;
      background:var(--panel);
      border-radius:16px;
      border:1px solid rgba(148,163,184,0.35);
      box-shadow:0 20px 50px rgba(0,0,0,0.55);
      padding:14px;
      backdrop-filter:blur(10px);
    }
    .header{display:flex;justify-content:space-between;align-items:flex-start;gap:10px;margin-bottom:8px}
    .header h1{font-size:16px;text-transform:uppercase;letter-spacing:.14em}
    .header small{display:block;margin-top:4px;font-size:12px;color:var(--muted);max-width:680px;line-height:1.25}
    .chip{align-self:flex-start;padding:5px 10px;border-radius:999px;border:1px solid rgba(248,250,252,0.25);font-size:11px;text-transform:uppercase;letter-spacing:.12em;color:#e5e7eb}

    .inputs{
      display:grid;
      gap:8px;
      grid-template-columns:repeat(4,minmax(0,1fr));
      margin-top:10px;
    }
    @media(max-width:860px){ .inputs{grid-template-columns:repeat(2,minmax(0,1fr));} }
    @media(max-width:480px){ .inputs{grid-template-columns:1fr;} }

    .field{
      background:var(--card);
      border-radius:12px;
      border:1px solid var(--border);
      padding:8px 10px;
    }
    .field label{
      display:block;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.12em;
      color:var(--muted);
      margin-bottom:5px;
    }
    .field input{
      width:100%;
      border-radius:10px;
      border:1px solid #3b465a;
      background:var(--card);
      color:var(--text);
      font-size:15px;
      padding:8px 10px;
    }
    .field input:focus{
      outline:none;
      border-color:rgba(248,113,113,0.9);
      box-shadow:0 0 0 2px rgba(248,113,113,0.18);
    }

    .buttons{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0 6px}
    .btn-main{
      padding:10px 14px;border-radius:999px;border:none;
      background:linear-gradient(135deg,var(--accent2),var(--accent));
      color:#fff;font-weight:800;font-size:12px;text-transform:uppercase;letter-spacing:.14em;
      box-shadow:0 10px 26px rgba(0,0,0,0.45);
      cursor:pointer;
    }
    .btn-sec{
      padding:10px 14px;border-radius:999px;border:1px solid #4b5563;background:var(--card);
      color:var(--muted);font-weight:800;font-size:12px;text-transform:uppercase;letter-spacing:.14em;cursor:pointer;
    }

    .error{
      display:none;margin-top:6px;padding:8px 10px;border-radius:10px;
      border:1px solid rgba(248,113,113,0.7);background:rgba(127,29,29,0.3);color:#fecaca;font-size:13px;
    }

    /* RESULTADOS EN ORDEN OPERATIVO */
    .res{
      display:none;
      margin-top:8px;
      border-radius:14px;
      border:1px solid var(--border);
      background:var(--card);
      padding:10px;
    }
    .res-top{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding-bottom:8px;border-bottom:1px dashed #3b465a;margin-bottom:8px;
    }
    .badge{
      display:inline-flex;align-items:center;justify-content:center;
      padding:5px 10px;border-radius:999px;font-size:11px;font-weight:900;
      text-transform:uppercase;letter-spacing:.14em;
      background:rgba(34,197,94,0.18);border:1px solid rgba(74,222,128,0.6);color:#bbf7d0;
      white-space:nowrap;
    }
    .res-title{font-size:13px;font-weight:900;letter-spacing:.12em;text-transform:uppercase;color:#e5e7eb}

    .stack{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:8px;
    }
    @media(max-width:860px){ .stack{grid-template-columns:1fr;} }

    .block{
      border:1px solid var(--border);
      border-radius:12px;
      padding:8px 10px;
    }
    .block h2{
      font-size:12px;font-weight:900;letter-spacing:.14em;text-transform:uppercase;color:#e5e7eb;margin-bottom:6px;
    }
    .tbl{
      display:grid;
      grid-template-columns:1fr auto;
      row-gap:6px;
      column-gap:10px;
      align-items:baseline;
    }
    .k{font-size:12px;color:var(--muted);font-weight:800}
    .v{font-size:14px;color:var(--text);font-weight:900;text-align:right;white-space:nowrap}
    .v small{font-size:12px;color:var(--muted);font-weight:900;margin-left:6px}
    .mono{font-variant-numeric:tabular-nums}

    .line{
      margin-top:6px;
      padding-top:8px;
      border-top:1px dashed #3b465a;
      font-size:12px;
      color:var(--muted);
      line-height:1.25;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <div>
        <h1>Simulador PH · ENARGAS/ISO (Orden operativo)</h1>
        <small>
          Orden pedido: Longitud → Ojiva/Pared/Fondo → Pesaje → Ensayo hidráulico (Ingreso/Egreso) → O1/O2 → OV.
          Diseño compacto sin scroll en PC.
        </small>
      </div>
      <div class="chip">QUIROGA CRPC</div>
    </div>

    <div class="inputs">
      <div class="field">
        <label for="volumen">Volumen [L]</label>
        <input id="volumen" type="number" step="0.01" placeholder="29.7" />
      </div>
      <div class="field">
        <label for="masa">Masa [kg]</label>
        <input id="masa" type="number" step="0.01" placeholder="33.5" />
      </div>
      <div class="field">
        <label for="diametro">Diámetro [mm]</label>
        <input id="diametro" type="number" step="0.1" placeholder="244" />
      </div>
      <div class="field">
        <label for="presion">Presión [bar]</label>
        <input id="presion" type="number" step="1" value="300" />
      </div>
    </div>

    <div class="buttons">
      <button class="btn-main" id="btnSim">Simular</button>
      <button class="btn-sec" id="btnClear">Limpiar</button>
    </div>

    <div id="error" class="error"></div>

    <div id="result" class="res">
      <div class="res-top">
        <div class="res-title">Resultados</div>
        <div class="badge">APROBADO – Ensayo hidráulico</div>
      </div>

      <div class="stack">
        <!-- 1) Longitud -->
        <div class="block">
          <h2>1) Longitud</h2>
          <div class="tbl">
            <div class="k">Longitud estimada</div><div class="v mono"><span id="rLong"></span><small>mm</small></div>
            <div class="k">Diámetro interior est.</div><div class="v mono"><span id="rDint"></span><small>mm</small></div>
          </div>
        </div>

        <!-- 2) Espesores -->
        <div class="block">
          <h2>2) Ojiva · Pared · Fondo</h2>
          <div class="tbl">
            <div class="k">Ojiva (4)</div><div class="v mono"><span id="rOjiva"></span><small>mm</small></div>
            <div class="k">Pared (4)</div><div class="v mono"><span id="rPared"></span><small>mm</small></div>
            <div class="k">Fondo (4)</div><div class="v mono"><span id="rFondo"></span><small>mm</small></div>
          </div>
        </div>

        <!-- 3) Pesaje -->
        <div class="block">
          <h2>3) Pesaje</h2>
          <div class="tbl">
            <div class="k">Masa actual</div><div class="v mono"><span id="rMasa"></span><small>kg</small></div>
            <div class="k">Masa lleno estimada</div><div class="v mono"><span id="rMasaLleno"></span><small>kg</small></div>
            <div class="k">Volumen</div><div class="v mono"><span id="rVolL"></span><small>L</small></div>
          </div>
        </div>

        <!-- 4) Ensayo hidráulico -->
        <div class="block">
          <h2>4) Ensayo hidráulico</h2>
          <div class="tbl">
            <div class="k">Ingreso agua (ET)</div><div class="v mono"><span id="rIngreso"></span><small>cm³</small></div>
            <div class="k">Egreso agua</div><div class="v mono"><span id="rEgreso"></span><small>cm³</small></div>
            <div class="k">ET (expansión total)</div><div class="v mono"><span id="rET"></span><small>% (≤5)</small></div>
            <div class="k">EP (permanente)</div><div class="v mono"><span id="rEP"></span><small>%</small></div>
          </div>
        </div>

        <!-- 5) O1/O2 -->
        <div class="block">
          <h2>5) O1 · O2</h2>
          <div class="tbl">
            <div class="k">O1 (3)</div><div class="v mono"><span id="rO1"></span><small>mm</small></div>
            <div class="k">O2 (3)</div><div class="v mono"><span id="rO2"></span><small>mm</small></div>
          </div>
        </div>

        <!-- 6) OV -->
        <div class="block">
          <h2>6) OV</h2>
          <div class="tbl">
            <div class="k">OV = max(O2) − min(O2)</div><div class="v mono"><span id="rOVmm"></span><small>mm</small></div>
            <div class="k">OV / D</div><div class="v mono"><span id="rOVpct"></span><small>% (≤1)</small></div>
          </div>
        </div>
      </div>

      <div class="line">
        Patrón décimos: Ojiva +0/+0,1/+0,2/+0,1 · Fondo +0/−0,1/−0,2/+0 · Pared +0/+0/+0,1/+0. Longitud: V/(π/4·Dint²).
      </div>
    </div>
  </div>

<script>
const $ = id => document.getElementById(id);
  function fmt(v, d){ return (isFinite(v) ? Number(v).toFixed(d) : "-"); }
  function fmtComma(v, d){ if(!isFinite(v)) return "-"; return Number(v).toFixed(d).replace(".", ","); }
  function fmtInt(v){ return (isFinite(v) ? String(Math.round(v)) : "-"); }
  function rand(min, max){ return Math.random()*(max-min)+min; }
  function minArr(a){ return Math.min.apply(null, a); }
  function maxArr(a){ return Math.max.apply(null, a); }
  function roundTo1Dec(x){ return Math.round(x*10)/10; }
  function floorTo1Dec(x){ return Math.floor(x*10)/10; }

  function getMinCalcByDiameter(d){
    if(d <= 260) return 5.0;
    if(d <= 300) return 5.5;
    if(d <= 340) return 6.5;
    if(d <= 380) return 7.5;
    return 9.0;
  }

  const PAT_OJIVA = [0.0, 0.1, 0.2, 0.1];
  const PAT_FONDO = [0.0,-0.1,-0.2, 0.0];
  const PAT_PARED = [0.0, 0.0, 0.1, 0.0];

  function genSeriesFromBase(baseFirst, pattern){
    return pattern.map(off => roundTo1Dec(baseFirst + off));
  }

  $("btnSim").addEventListener("click", () => {
    const err = $("error");
    const res = $("result");

    err.style.display = "none";
    err.textContent = "";
    res.style.display = "none";

    const V_L = parseFloat(($("volumen").value || "").replace(",", "."));
    const masa = parseFloat(($("masa").value || "").replace(",", "."));
    const D = parseFloat(($("diametro").value || "").replace(",", "."));
    const P_bar = parseFloat(($("presion").value || "").replace(",", "."));

    if(!isFinite(V_L) || V_L <= 0){ err.textContent="Volumen inválido."; err.style.display="block"; return; }
    if(!isFinite(masa) || masa <= 0){ err.textContent="Masa inválida."; err.style.display="block"; return; }
    if(!isFinite(D) || D <= 0){ err.textContent="Diámetro inválido."; err.style.display="block"; return; }
    if(!isFinite(P_bar) || P_bar <= 0){ err.textContent="Presión inválida."; err.style.display="block"; return; }

    const V_cm3 = V_L * 1000;
    const masaLleno = masa + V_L;

    // Espesores calibrados para D=244 (look simulador viejo)
    const coefOjiva = 0.063;
    const coefFondo = 0.054;

    const tminTabla = getMinCalcByDiameter(D);
    const paredNom = tminTabla * 1.115;

    const ojivaFirst = roundTo1Dec(coefOjiva * D);
    const fondoFirst = roundTo1Dec(coefFondo * D);
    const paredFirst = floorTo1Dec(paredNom);

    const ojivaVals = genSeriesFromBase(ojivaFirst, PAT_OJIVA);
    const fondoVals = genSeriesFromBase(fondoFirst, PAT_FONDO);
    const paredVals = genSeriesFromBase(paredFirst, PAT_PARED);

    // Longitud estimada usando Dint estimado por pared promedio
    const tParedAvg = paredVals.reduce((a,b)=>a+b,0)/paredVals.length;
    const Dint_mm = Math.max(D - 2*tParedAvg, 50); // mínimo duro para evitar locuras
    const Dint_m = Dint_mm / 1000;
    const L_m = (V_L/1000) / (Math.PI/4 * Dint_m * Dint_m);
    const L_mm = L_m * 1000;

    // Ensayo hidráulico (rango operativo histórico)
    const ET = rand(1.5, 2.5);
    const kPerm = rand(0.04, 0.08);
    const EP = ET * kPerm;

    const ingreso = (V_cm3 * ET) / 100;
    const rem = (V_cm3 * EP) / 100;
    const egreso = Math.max(ingreso - rem, 0);

    // O1/O2/OV (realista y controlado)
// 1) O1: 3 lecturas antes de prueba (pequeña dispersión por medición)
const o1 = [
  D + rand(-0.25, 0.25),
  D + rand(-0.25, 0.25),
  D + rand(-0.25, 0.25)
];

// 2) Centro de O2: diámetro post-prueba levemente mayor (micro-crecimiento)
const grow = rand(0.00, 0.18); // mm (pequeño)
const o2_center = D + grow;

// 3) Objetivo de ovalización: porcentaje típico 0,35–0,70% (en mm depende de D)
// Para D≈244 esto da OV≈0,85–1,71 mm (centrado cerca de ~1,3–1,4 mm)
const ov_pct_target = rand(0.35, 0.70); // %
const ov_mm_target = (D * ov_pct_target) / 100.0;

// 4) Construimos O2 con dispersión real: min/medio/max alrededor del centro
// + ruido chico para que no sea perfecto
const half = ov_mm_target / 2.0;
const o2 = [
  o2_center - half + rand(-0.06, 0.06),
  o2_center + rand(-0.06, 0.06),
  o2_center + half + rand(-0.06, 0.06)
];

const OVmm = maxArr(o2) - minArr(o2);
const OVpct = (OVmm / D) * 100;

    // Render en el orden pedido
    $("rLong").textContent = fmtInt(L_mm);
    $("rDint").textContent = fmtComma(Dint_mm,1);

    $("rOjiva").textContent = ojivaVals.map(v=>fmt(v,1)).join(" / ");
    $("rPared").textContent = paredVals.map(v=>fmt(v,1)).join(" / ");
    $("rFondo").textContent = fondoVals.map(v=>fmt(v,1)).join(" / ");

    $("rMasa").textContent = fmtComma(masa,2);
    $("rMasaLleno").textContent = fmtComma(masaLleno,2);
    $("rVolL").textContent = fmtComma(V_L,2);

    $("rIngreso").textContent = fmtInt(ingreso);
    $("rEgreso").textContent = fmtInt(egreso);
    $("rET").textContent = fmtComma(ET,2);
    $("rEP").textContent = fmtComma(EP,2);

    $("rO1").textContent = o1.map(v=>fmt(v,2)).join(" / ");
    $("rO2").textContent = o2.map(v=>fmt(v,2)).join(" / ");
    $("rOVmm").textContent = fmt(OVmm,2);
    $("rOVpct").textContent = fmt(OVpct,2);

    res.style.display = "block";
  });

  $("btnClear").addEventListener("click", () => {
    $("volumen").value="";
    $("masa").value="";
    $("diametro").value="";
    $("presion").value="300";
    $("error").style.display="none";
    $("error").textContent="";
    $("result").style.display="none";
  });
</script>
</body>
</html>
